<!DOCTYPE html>
<html lang="en" style="height:100%;">
   <head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <title id="title">Procedure</title>
      <script src="/head.js"></script>
      <script src="/error.js"></script>
      <script src="/client/stream/stream.js"></script>
      <script src="/client/power-encoding/power-encoding.js"></script>
      <script src="/client/id/id.js"></script>
      <script src="/client/evaluate.js"></script>      <script src="/client/logon/authentication.js"></script>
      <script src="/client/punycode.js"></script>
      <script src="/client/coordinates/script.js"></script>
      <script src="/client/movable/script.js"></script>
 
      <link rel="stylesheet" type="text/css" href="style.css"/>
      <script>

      </script>
      <style>
body {
   border: 1px solid;
   margin: 0px;
   padding: 10px;
   height: 100%;
   width: 100%;
}


form {
    width: 250px;
    background-color: lightblue;
    position: absolute;
    background-image: url('move.png');
    background-repeat: no-repeat;
    background-size: 30px 30px;
    background-position: right 2px top 2px;
}

textarea, input {
   left: 5px;
   right: 5px;
   margin: auto;
   padding: auto;
   margin-top: 5px;
   width: calc(100% - 10px);
}

textarea {
   height: 100px;
}

input {
   border: 1px solid;
}
select {
   margin-top: 5px;}

button {
   position: absolute;
   right: -5px;
   bottom: -5px;
   width: 40px;}

.svg {
   clear: both;
   padding: 0px;
   padding-top: 10px;
   width: calc(100% - 10px);
   
}


      </style>
   </head>
   <body>
      <h1 id="h1">Procedure</h1><!--
      <form class="movable" id="Procedure 1" onsubmit="return false;">
        
        <label contenteditable="true">Procedure 1</label>
        
         <br/>
         
         <select onchange="onProcedureTypeChange(this, ['Procedure 1 functionDiv', 'Procedure 1 inputDiv', 'Procedure 1 gotoDiv'])">
            <option value="Procedure 1 functionDiv" selected="selected">Function</option>
            <option value="Procedure 1 gotoDiv">Go to</option>
            <option value="Procedure 1 inputDiv">Input</option>
         </select>
  
         <div id="Procedure 1 functionDiv" style="display:block;">
            <textarea id="Procedure 1 function"></textarea>
         </div>
         
         <div id="Procedure 1 gotoDiv" style="display:none;">
            <svg >
               <rect width="100" 
                     height="100" 
                     x="10" 
                     y="10" 
                     rx="20"
                     ry="20"
                     fill="pink" />
            </svg>
         
         </div>
         
         
         <div id="Procedure 1 inputDiv" style="display:none;">
            <label contentEditable="true">Label</label>
            <br/>
               <select onchange="onInputTypeChange(this, 'Procedure 1 input')">
                  <option value="button">Button</option>
                  <option value="checkbox">Check box</option>
                  <option value="color">Color</option>
                  <option value="date">Date</option>
                  <option value="datetime-local">Date time</option>
                  <option value="email">Email</option>
                  <option value="file">File</option>
                  <option value="image">Image</option>
                  <option value="month">Month</option>
                  <option value="number">Number</option>
                  <option value="password">Password</option>
                  <option value="radio">Radio</option>
                  <option value="range">Range</option>
                  <option value="reset">Reset</option>
                  <option value="search">Search</option>
                  <option value="submit">Submit</option>
                  <option value="tel">Telephone</option>
                  <option value="text" selected="selected">Text</option>
                  <option value="time">Time</option>
                  <option value="url">URL</option>
                  <option value="week">Week</option>
               </select>
               <br/>
               <input id="Procedure 1 input" type="text"></input>
            
         </div>
         <br/>
         <button>Go</button>
      </form>
      -->
      <script>
var procedures =
{
   "Procedure 1": {
      "function": "function() {\r\n   alert('hello world');\r\n}",
      "topLeft": {
         "x": "50",
         "y": "100"
      }
   },
   "Procedure 2": {
      "input": "range",
      "topLeft": {
         "x": "50",
         "y": "350"
      }
   },
   "Procedure 3": {
      "goto": makeId("Procedure 1"),
      "topLeft": {
         "x": "50",
         "y": "500"
      }
   },
   "routes": [
      {
         "from" : makeId("Procedure 1"),
         "to": makeId("Procedure 2")
      },
      {
         "from" : makeId("Procedure 3"),
         "to": makeId("Procedure 3")
      }
   ]
      
}
function createProcedures() {
   for (var label in procedures) {
      if (label != "routes")
         createProcedureHTML(label);
   }
}

function createProcedureHTML(label) {

   var procedure =
      procedures[label];
   
   var json = {
      "form": {
         "id": makeId(label),
         "className": "movable",
         "style": {
            "position": "absolute",
            "top": procedure.topLeft.y + "px",
            "left": procedure.topLeft.x + "px"
         },
         "onmoving":
function (event) {
   procedure.topLeft = event.point;
},
         "onsubmit":
function() {
   return false;
},
         "children": [
            {
               "label": {
                  "id": makeId(label, "label"),
                  "contentEditable": "true",
                  "innerText": label
               }
            },
            {
               "br": {}
            },
            {
               "select": {
                  "style": {
                     "float": "left"
                  },
                  "children": [
                     createOption("Function", makeId(label, "functionDiv"), procedure.function != undefined),
                     createOption("Goto", makeId(label, "gotoDiv"), procedure.goto != undefined),
                     createOption("Input", makeId(label, "inputDiv"), procedure.input != undefined)
                  ],
                  "onchange":
function(event) {
   onProcedureTypeChange(
      this,
      [
         makeId(label, "functionDiv"),
         makeId(label, "gotoDiv"),
         makeId(label, "inputDiv")
      ]
   );
}
    
               }
            },
            
            {
               "div": {
                  "id": makeId(label, "functionDiv"),
                  "style": {
                     "display": procedure["function"] ? "block" : "none"
                  },
                  "children": [
                     {
                        "textarea": {
                           "id": makeId(label, "function"),
                           "innerHTML": procedure.function,
                           "onblur":
function(event) {
   procedure.function = this.innerHTML;
   delete procedure.input;
   delete procedure.goto;
}
                        }
                     }
                  ]
               }
            },
            {
               "div": {
                  "id": makeId(label, "gotoDiv"),
                  "className": "svg",
                  "style": {
                     "display": procedure["goto"] ? "block" : "none",
                  },
                  "children": [
                     {
                        "svg": {
                           "id": makeId(label, "svg"),
                           "attributes": {
                              "width": "100",
                              "height": "100"
                           },
                           "children": [
                              {
                                 "rect": {
                                    "attributes" : {
                                       "width": "100",
                                       "height": "100",
                                       "x": "0",
                                       "y": "0",
                                       "rx": "20",
                                       "ry": "20",
                                       "fill": "pink"
                                    }
                                 }
                              }
                           ]
                        }
                     }
                  ]
               }
            },
            {
               "div": {
                  "id": makeId(label, "inputDiv"),
                  "style": {
                     "display": procedure["input"] ? "block" : "none"
                  },
                  "children": [
                     {
                        "select": {
                           "onchange":
function (event) {
   var inputId = makeId(label, "input");
   var input = document.getElementById(inputId);
   
   input.type = this.value;
   input.value = "";
   procedure.input = input.type;
   delete procedure.function;
   delete procedure.goto;
},
                           "children": [
                              createOption("Button", "button", procedure["input"] == "button"),
                              createOption("Check box", "checkbox", procedure["input"] == "checkbox"),
                              createOption("Color", "color", procedure["input"] == "color"),
                              createOption("Date", "date", procedure["input"] == "date"),
                              createOption("Date time", "datetime-local", procedure["input"] == "datetime-local"),
                              createOption("Email", "email", procedure["input"] == "email"),
                              createOption("File", "file", procedure["input"] == "file"),
                              createOption("Image", "image", procedure["input"] == "image"),
                              createOption("Month", "month", procedure["input"] == "month"),
                              createOption("Number", "number", procedure["input"] == "number"),
                              createOption("Password", "password", procedure["input"] == "password"),
                              createOption("Radio", "radio", procedure["input"] == "radio"),
                              createOption("Range", "range", procedure["input"] == "range"),
                              createOption("Reset", "reset", procedure["input"] == "reset"),
                              createOption("Search", "search", procedure["input"] == "search"),
                              createOption("Submit", "submit", procedure["input"] == "submit"),
                              createOption("Telephone", "tel", procedure["input"] == "tel"),
                              createOption("Text", "text", procedure["input"] == "text"),
                              createOption("Time", "time", procedure["input"] == "button"),
                              createOption("URL", "url", procedure["input"] == "time"),
                              createOption("Week", "week", procedure["input"] == "week"),
                           ]
                        }
                     },
                     {
                        "input": {
                           "id": makeId(label, "input"),
                           "type": procedure.input
                        }
                     }
                  ]
               }
            },
            {"br":{}},
            {
               "button": {
                  "innerText": "Go"
               }
            }
            
         ]
         
      }
   };
   /*
   document.write("<pre>");
   document.write(JSON.stringify(json, null, "   "));
   document.write("</pre>");
   */
   HTML(json, document.body);
   
   
}

function makeId(label, id) {
    
   var _id = label + (id ? " " + id : "");

   _id = _id.replaceAll(" ", "_");
  
   return _id;}

function createOption(label, value, selected=undefined) {
   return {
      "option": {
         "value": value,
         "innerText": label,
         "selected": selected ? "true" : undefined
      }
   }
}
   

function onProcedureTypeChange(select, divIds) {
   // Hide all
   for (var i = 0; i < divIds.length; ++i) {
      var id = divIds[i];
      var div = document.getElementById(id);
      div.style.display = "none";
   }
   
   // Display selected
   var selected = select.value;
   var div = document.getElementById(selected);
   
   div.style.display = "block";
   
}

function onNewProcedure(event) {
   var label = "Procedure ";
   var count = 1;
   while (procedures[label + count])
      ++count;
      
   label += count;
   
   while (true) {
      label = prompt("New procedure", label);
      if (!label)
         return;
         
      if (procedures[label])
         alert(label + " already exists");
      else
         break;
         
   };
   
   var point = coordinates.getCoordinates(event);
   
   procedures[label] = {
      "function": "function() {\r\n   alert('hello');\r\n}",
      "topLeft": {
         "x": point.x - 100,
         "y": point.y
      }
   };
   
   createProcedureHTML(label);
   
}

document.body.onclick =
   function (event) {
      if (event.target == document.body) {
         onNewProcedure(event);
         //var e = document.getElementById(makeId("Procedure 2"));
         //alert(e);
      }
   }

createProcedures();
      </script>
      
      
      <script>
var header = document.getElementById("h1");
var title = document.getElementById("title");

var origin =
   punycode.toUnicode(
      window.location.hostname
   );

header.innerText = "Procedure " + origin;
title.innerText = origin;

      </script>
   </body>

</html>