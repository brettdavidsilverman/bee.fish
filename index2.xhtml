<?xml version="1.0" ?>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
   <head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <!--
      <script src="https://bee.fish/head.js"/>
      <script src="https://bee.fish/client/stream/stream.js"/>
      <script src="https://bee.fish/client/power-encoding/power-encoding.js"/>
      <script src="https://bee.fish/client/id/id.js"/>
      <script src="https://bee.fish/client/evaluate.js"/>
      -->
      <title>bee.fish</title>
      <style>
textarea {
   left: 10px;
   width: calc(100% - 20px);
   height: 120px;
}
      </style>
   </head>
   <body>
      <h1 id="h1">bee.fish.2</h1>
      <div>
         <form onsubmit="return false;">
            <label for="url">Path</label>
            <br/>
            <input type="url" id="url"/>
            <button 
              onclick="loadJSON()">Go</button>
         </form>
         <br/>
         <form onsubmit="return false;">
         
            <label for="jsonEditor">JSON Editor</label>
            <br/>            <textarea id="jsonEditor"></textarea>
            <button onclick="postJSON(url.value, jsonEditor.value);">Save</button>
         
         </form>
      </div>
      <br />
      <pre id="result">
      </pre>
      <div id="html">
      </div>
      <br />
      <a href="https://bee.fish/client/">Javascript client library</a>
      <br />
      <a href="https://github.com/brettdavidsilverman/bee.fish">Bee.Fish on Git Hub</a>
      
      <script>
var url = document.getElementById("url");
var result = document.getElementById("result");
var jsonEditor = document.getElementById("jsonEditor");var html = document.getElementById("html");

document.getElementById("h1").innerText =
   window.location.hostname + ".2";
   
if (window.location.search) {
   // fill out form from search
   var _url = decodeURI(
      window.location.search.substr(1)
   );
   url.value =
      _url;
}

function evaluate(json, parent)
{
   switch(typeof(json)) {
   case "string":
      var string = json;
      if (string.startsWith("_{") &&
          string.endsWith("}"))
      {
         var func = new Function(string.substr(1));
         var evaluated = func.call(parent);
         
         if (evaluated == undefined)
            evaluated = string;

         return evaluated;
      }
      else
         return string;
      break;
   case "object":
      for (property in json)
      {
         var newProperty =
            evaluate(property, json);

         if (newProperty == undefined)
            newProperty = property;
            
         var newValue =
            evaluate(json[property], json);
            
         json[newProperty] =
            newValue;
            
         if (newProperty != property)
            json[property] = undefined;
      }
      return json;
      break;
    
   default:
      return json;
   }
}

function loadJSON() {
   fetch("https://bee.fish/" + url.value)
   .then
   (
      function (response) {
         return response.text();
      }
   )
   .then(
      function(text) {
         alert(text);
         var json = JSON.parse(text);
         jsonEditor.value = "";
         
         if (json == undefined)
            return; 
            
         jsonEditor.value = text;
         
         var evaluated = evaluate(json);
         
         result.innerText =
            evaluated.toString();
            
         return json;
      }
   )
   .catch(
      function (error) {
         alert(error);
      }
   );
      
}



      </script>

   </body>

</html>