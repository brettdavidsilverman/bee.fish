<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <script src="/head.js"></script>
      <script src="/error.js"></script>
      <script src="/client/stream/stream.js"></script>
      <script src="/client/power-encoding/power-encoding.js"></script>
      <script src="/client/id/id.js"></script>
      <script src="/client/evaluate.js"></script>      <script src="/client/logon/authentication.js"></script>
      <title>bee.fish</title>
      <style>
textarea {
   left: 10px;
   width: calc(100% - 20px);
   height: 120px;
}
      </style>
      <script>
authenticate();
      </script>
   </head>
   <body>
      <h1 id="h1">bee.fish</h1>
      <div>
         <form onsubmit="return false;">
            <label for="urlInput">Path</label>
            <br/>
            <input type="text" id="urlInput"/>
            <button id="fetchButton" onclick="loadJSON()">Fetch</button>
            <br/>
         </form>
         <br/>
         <form onsubmit="return false;">
         
            <label for="jsonEditor">JSON Editor <input type="checkbox" id="functionCheckbox" onclick="switchFunctions(this.checked)"><i> f()</i></input></label>
            <br/>            <textarea id="jsonEditor"></textarea>
            <button id="saveButton">Save</button>
         
         </form>
         
      </div>
      <br />
      <button id="goButton">Go</button>
      <br />
      <pre id="result">
      </pre>
      <div id="html">
      </div>
      <br />
      <a id="goLink"></a>
      <br />
      <br />
      <a href="https://bee.fish:8000/client/logon/" id="logon">Logon/Logoff</a>
      <br />
      <a href="https://bee.fish:8000/client/">Javascript client library</a>
      <br />
      <a href="https://github.com/brettdavidsilverman/bee.fish">Bee.Fish on Git Hub</a>
      <script>
const defaultURL = 
   "Type the path of your document";
   var logon = document.getElementById("logon");
logon.href += "?redirect=" + encodeURIComponent(window.location.href);

var urlInput = document.getElementById("urlInput");
var result = document.getElementById("result");
var jsonEditor = document.getElementById("jsonEditor");var html = document.getElementById("html");
var goButton = document.getElementById("goButton");var goLink = document.getElementById("goLink");var fetchButton = document.getElementById("fetchButton");var saveButton = document.getElementById("saveButton");var functionCheckbox = document.getElementById("functionCheckbox");

document.getElementById("h1").innerText =
   window.location.hostname;


function getJSON()
{
   var json = jsonEditor.value;
   
   if (json == "")
      return undefined;
      
   var f = new Function(
      "return (" + json + ")"
   );
   json = f();
   return json;
}

function switchFunctions(showFunctions)
{

   var json = getJSON();
   
   if (showFunctions) {
      json = displayFunctions(json);
   }
   else {
      json = hideFunctions(json);
      if (typeof json == "string")
         json = JSON.stringify(json);
   
   }
   jsonEditor.value = json;
}

function loadJSON() {
    
   var url = urlInput.value;
   
   if (url == defaultURL)
      return;
      
   var search = document.location.search;
   if (search != ("?" + encodeURI(url))) {
      document.location.search =
         "?" + url;
      return;
   }

   fetchButton.disabled = true;
 
   var promise =
   fetchJSON(url).
   then(
      function(json) {
         setLink();

         if (json == undefined) {
            jsonEditor.value = "undefined";
         }
         else if (json.error) {
            throw(json.error);
            return;
         }
         else if (typeof(json) == "string") {
            jsonEditor.value =
               JSON.stringify(json);
         }
         else
            jsonEditor.value = json;
            
         fetchButton.disabled = false;
         saveButton.disabled = false;
         switchFunctions(
             functionCheckbox.checked
         );
         return json;
      }
   )
   .catch(
      function (error) {
         fetchButton.disabled = false;
         Error(error, loadJSON);
      }
   );
   
   return promise;
      
}

function setLink()
{
   var url = urlInput.value;
   
   if (url == defaultURL) {
      goLink.style.visibility = "hidden";
      return;
   }
 
   goLink.style.visibility = "inline";
   
   goLink.href = 
       "https://bee.fish/?" +
            url + "#go";
            
   goLink.innerText = "Go link for " + url;
      
}

function Go() {

   var json = getJSON();
   
   json = evaluate(json);
   
   result.innerText =
      hideFunctions(json);
 
}


urlInput.onchange =
   () => {
      setLink();
   }


if (!urlInput.value)
   urlInput.value = defaultURL;
   
urlInput.onfocus = 
   function() {
      if (urlInput.value == defaultURL)
         urlInput.value = "";
   };
   
   
urlInput.onblur =
   function() {
      if (urlInput.value == "")
         urlInput.value = defaultURL;
      else
         goButton.value = "";
   }
   
goButton.onclick =
   function() {
      Go();
   }
   
goLink.onclick =
   function() {
      document.location.hash = "#go";
      Go();
   }
   

saveButton.onclick =
   function() {
      postJSON(
         urlInput.value,
         formatJSON(jsonEditor.value)
      );
   }

fetchButton.onclick =
   function() {
      if (document.location.search != 
           ("?" + encodeURI(url)))
      {
         document.location.search = "?" + url;
         //return;
      }
      loadJSON();

   }
   
if (document.location.search) {
    
   // fill out form from search
   var url = decodeURI(
      document.location.search.substr(1)
   );

   urlInput.value =
      url;
      
   
}
loadJSON().then(
   function(json) {
      if (document.location.hash == "#go")
         Go();
   }
);

      </script>

   </body>

</html>