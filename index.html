<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <script src="/head.js"></script>
      <script src="/client/stream/stream.js"></script>
      <script src="/client/power-encoding/power-encoding.js"></script>
      <script src="/client/id/id.js"></script>
      <script src="/client/evaluate.js"></script>      <script src="/client/logon/authentication.js"></script>
      <title>bee.fish</title>
      <style>
textarea {
   left: 10px;
   width: calc(100% - 20px);
   height: 120px;
}
      </style>
      <script>
authenticate();
      </script>
   </head>
   <body>
      <h1 id="h1">bee.fish.2</h1>
      <div>
         <form onsubmit="return false;">
            <label for="url">Path</label>
            <br/>
            <input type="text" id="url"/>
            <button id="fetch"
              onclick="loadJSON(url.value)">Fetch</button>
            <br/>
         </form>
         <br/>
         <form onsubmit="return false;">
         
            <label for="jsonEditor">JSON Editor</label>
            <br/>            <textarea id="jsonEditor"></textarea>
            <button onclick="postJSON(url.value, jsonEditor.value);">Save</button>
         
         </form>
         
      </div>
      <a id="goLink" href="https://bee.fish/">Go Link</a>
      <br />
      <pre id="result">
      </pre>
      <div id="html">
      </div>
      <br />
      <a href="https://bee.fish:8000/client/logon/" id="logon">Logon/Logoff</a>
      <br />
      <a href="https://bee.fish:8000/client/">Javascript client library</a>
      <br />
      <a href="https://github.com/brettdavidsilverman/bee.fish">Bee.Fish on Git Hub</a>
      <script>

const defaultURL = 
   "Type the path of your document";
   var logon = document.getElementById("logon");
logon.href += "?redirect=" + encodeURIComponent(window.location.href);

var url = document.getElementById("url");
var result = document.getElementById("result");
var jsonEditor = document.getElementById("jsonEditor");var html = document.getElementById("html");
var goLink = document.getElementById("goLink");var _fetch = document.getElementById("fetch");

document.getElementById("h1").innerText =
   window.location.hostname + ".2";

if (window.location.search) {
   // fill out form from search
   var _url = decodeURI(
      window.location.search.substr(1)
   );
   url.value =
      _url;
   
}


function loadJSON(url) {
   if (url == defaultURL)
      return;
      
   fetch("https://bee.fish/" + url)
   .then
   (
      function (response) {
         if (response.status == 404)
            throw new Error("Not found");
         else if (response.status != 200)
            throw new Error(response.status);
               
         return response.json();
      }
   )
   .then(
      function(json) {
          
         if (json == undefined)
         {
            jsonEditor.value = "";
            return; 
         }
         
         if (json.error)
            throw new Error(json.error);

         if(typeof(json) == "string")
         {
            jsonEditor.value =
               JSON.stringify(json);
         }
         else
            jsonEditor.value = json.toString();
         
         if (document.location.hash == "#go")
         {
            var evaluated = evaluate(
               json
            );
            
            result.innerText =
               evaluated.toString();
         }
         
         return json;
      }
   ).then(
      () =>
      {
         setLink();
      }
   )
   .catch(
      function (error) {
         alert(error);
      }
   );
      
}

function postJSON(url, json) {
   var response =
      fetch(
         "https://bee.fish/" + url,
         {
            method: "POST",
            body: json
         }
      ).then(
         function (response) {
            return response.text();
         }
      ).then(
         function (json) {
            alert(json);
         }
      ).catch(
         function(error) {
            alert(error);
         }
      );

   return response;
}

function setLink()
{
   if (url.value == defaultURL)
      goLink.style.visibility = "hidden";
   else
      goLink.style.visibility = "";
      
   goLink.href = 
      "https://bee.fish/?" +
      url.value +
      "#go";
      
}

url.onchange =
   () => {
      setLink();
   }


if (!url.value)
   url.value = defaultURL;else
   loadJSON(url.value);
url.onfocus = 
   () => {
      if (url.value == defaultURL)
         url.value = "";
   };
   
   
url.onblur =
   () => {
      if (url.value == "")
         url.value = defaultURL;
      else
         goLink.value = "";
   }
   
   
url.onchange();

      </script>

   </body>

</html>