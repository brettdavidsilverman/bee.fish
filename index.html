<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <script src="/head.js"></script>
      <script src="/client/stream/stream.js"></script>
      <script src="/client/power-encoding/power-encoding.js"></script>
      <script src="/client/id/id.js"></script>
      <script src="/client/evaluate.js"></script>      <script src="/client/logon/authentication.js"></script>
      <script>
authenticate().then(
   function(auth)
   {
      if (auth.authenticated)
         alert("Logged in with session id " + auth.sessionId);
   }
);

      </script>
      <title>bee.fish</title>
      <style>
textarea {
   left: 10px;
   width: calc(100% - 20px);
   height: 120px;
}
      </style>
   </head>
   <body>
      <h1 id="h1">bee.fish.2</h1>
      <div>
         <form onsubmit="return false;">
            <label for="url">Path</label>
            <br/>
            <input type="url" id="url"
               onblur="setLink()"/>
            <button 
              onclick="loadJSON(url.value)">Fetch</button>
            <br/>
         </form>
         <br/>
         <form onsubmit="return false;">
         
            <label for="jsonEditor">JSON Editor</label>
            <br/>            <textarea id="jsonEditor"></textarea>
            <button onclick="postJSON(url.value, jsonEditor.value);">Save</button>
         
         </form>
         
      </div>
      <a id="encodedURL" target="_blank">Link to path</a>
      <br />
      <pre id="result">
      </pre>
      <div id="html">
      </div>
      <br />
      <a href="https://bee.fish:8000/client/logon/" id="logon">Logon</a>
      <br />
      <a href="https://bee.fish:8000/client/">Javascript client library</a>
      <br />
      <a href="https://github.com/brettdavidsilverman/bee.fish">Bee.Fish on Git Hub</a>
      <script>

var logon = document.getElementById("logon");
logon.href += "?redirect=" + encodeURIComponent(window.location.href);

var url = document.getElementById("url");
var result = document.getElementById("result");
var jsonEditor = document.getElementById("jsonEditor");var html = document.getElementById("html");
var encodedURL = document.getElementById("encodedURL");
url.focus();

document.getElementById("h1").innerText =
   window.location.hostname + ".2";

if (window.location.search) {
   // fill out form from search
   var _url = decodeURI(
      window.location.search.substr(1)
   );
   url.value =
      _url;
   
}


function loadJSON(url) {
   fetch("https://bee.fish/" + url)
   .then
   (
      function (response) {
         if (response.status == 404)
            throw new Error("Not found");
         else if (response.status != 200)
            throw new Error(response.status);
               
         return response.text();
      }
   )
   .then(
      function(json) {
          
         if (json == undefined)
         {
            jsonEditor.value = "";
            return; 
         }

         jsonEditor.value = json;
         
         if (document.location.hash == "#go")
         {
            var evaluated = evaluate(
               JSON.parse(json)
            );
            
            result.innerText =
               evaluated.toString();
         }
         
         return json;
      }
   )
   .catch(
      function (error) {
         alert(error);
      }
   );
      
}

function postJSON(url, json) {
   var response =
      fetch(
         "https://bee.fish/" + url,
         {
            method: "POST",
            body: json
         }
      ).then(
         function (response) {
            return response.text();
         }
      ).then(
         function (json) {
            alert(json);
         }
      ).catch(
         function(error) {
            alert(error);
         }
      );

   return response;
}

function setLink()
{
   encodedURL.href = 
      "https://bee.fish/?" +
      url.value +
      "#go";
      
   encodedURL.innerHTML =
      encodedURL.href;
}

if (url.value)
   loadJSON(url.value);
   
setLink();

      </script>

   </body>

</html>