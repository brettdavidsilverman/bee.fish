<html lang="en">
   <head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <title id="title">Procedure</title>
      <script src="/head.js"></script>
      <script src="/error.js"></script>
      <script src="/client/stream/stream.js"></script>
      <script src="/client/power-encoding/power-encoding.js"></script>
      <script src="/client/id/id.js"></script>
      <script src="/client/evaluate.js"></script>      <script src="/client/logon/authentication.js"></script>
      <script src="/client/punycode.js"></script>
      <script src="/client/coordinates/script.js"></script>
      <script src="/client/movable/script.js"></script>
 
      <link rel="stylesheet" type="text/css" href="/style.css"/>
      <style>
body {
   border: 1px solid;
   margin: 0px;
   padding: 0px;
}


form {
    width: 250px;
    position: absolute;
    background-image: url('move.png');
    background-repeat: no-repeat;
    background-size: 30px 30px;
    background-position: right 2px top 2px;
}

.ready {
   background-color: lightblue;
}

.error {
   background-color: pink;
}

.complete {
   background-color: lightgreen;
}

textarea, input {
   left: 5px;
   right: 5px;
   margin: auto;
   padding: auto;
   margin-top: 5px;
   margin-bottom: 5px;
   width: calc(100% - 5px);
}

textarea {
   height: 100px;
}

input {
   border: 1px solid;
}
select {
   margin-top: 5px;}

.go, .connect, .delete {
   position: absolute;
   right: -5px;
   bottom: -5px;
   width: 40px;}

.connect {
   left: 60px;
   right: auto;
   width: auto;
}

.delete {
   left: 0px;
   right: auto;
   width: auto;
}

.gotoSVG {
   clear: both;
   padding: 0px;
   padding-top: 10px;
   width: calc(100% - 10px);
   
}

.gotoSelect {
    position: absolute;
    right: 5px;
    top: 125px;
}

#svg {
   position: absolute;
   top: 0px;
   left: 0px;
   width: 100%;
   margin: 0px;
   padding: 0px;
   height: 100%;
   border: 1px solid red;
}


      </style>
   </head>
   <body>
      <h1 id="h1">Procedure</h1>
      <svg id="svg">
      </svg>      <script>
var procedures =
{
   "Procedure 1": {
      "function": "function() {\r\n   alert('hello world');\r\n}",
      "topLeft": {
         "x": 50,
         "y": 100
      }
   },
   "Procedure 2": {
      "input": "range",
      "topLeft": {
         "x": 50,
         "y": 350
      }
   },
   "Procedure 3": {
      "goto": "Procedure 1",
      "topLeft": {
         "x": 50,
         "y": 500
      }
   },
   "routes": [
      {
         "from": "Procedure 1",
         "to": "Procedure 2"
      }
   ]
      
}

var connectFrom;
var connectTo;
   
function createProcedure(label) {

   var procedure =
      procedures[label];
      
   var json = {
      "form": {
         "id": makeId(label),
         "className": "movable",
         "style": {
            "position": "absolute",
            "top": procedure.topLeft.y + "px",
            "left": procedure.topLeft.x + "px"
         },
         "onmoving":
function (event) {
   procedure.topLeft = event.point;
   window.onresize();
},
         "onsubmit":
function() {
   return false;
},
         "children": [
            {
               "label": {
                  "id": makeId(label, "label"),
                  "contentEditable": "true",
                  "innerText": label,
                  "onblur":
function (event) {
   var _label =
      document.getElementById(
         makeId(label, "label")
      );
      
   var newLabel =
      _label.innerText;
   
   if (newLabel == label)
      return;
      
   var test = document.getElementById(newLabel);
   if (test) {
      alert(newLabel + " already exists");
      _label.innerText = label;
      return;
   }
   
   changeLabel(label, newLabel);
}
               }
            },
            {
               "br": {}
            },
            {
               "select": {
                  "style": {
                     "float": "left"
                  },
                  "children": [
                     createOption("Function", makeId(label, "functionDiv"), procedure.function != undefined),
                     createOption("Goto", makeId(label, "gotoDiv"), procedure.goto != undefined),
                     createOption("Input", makeId(label, "inputDiv"), procedure.input != undefined)
                  ],
                  "onchange":
function(event) {
   onProcedureTypeChange(
      this,
      [
         makeId(label, "functionDiv"),
         makeId(label, "gotoDiv"),
         makeId(label, "inputDiv")
      ]
   );
}
    
               }
            },
            createFunctionDiv(),
            createGotoDiv(),
            createInputDiv(),
            {"br":{}},
            {
               "button": {
                  "className": "connect",
                  "innerText": "connect",
                  "onclick":
function(event) {
   if (!connectFrom) {
      var fromId = makeId(label);
      connectFrom =
         document.getElementById(fromId);
      connectTo = null;
      alert("Click connect on a downstream procedure");
   }
   else if (!connectTo) {
       var toId = makeId(label);
       connectTo =
          document.getElementById(toId);
   }
   
   
   if (connectFrom && connectTo) {
      if (connectFrom != connectTo) {
          
         if (!procedures.routes)
            procedures.routes = [];
            
         var routes = procedures.routes;
         
         // Check if this route already exists
         var exists = false;
         for (var index = 0;
              index < routes.length;
              ++index)
         {
            
            var route = routes[index];
            if (route.from == connectFrom.id &&
                route.to == connectTo.id)
            {
               if (confirm("This route exists. Delete it?"))
               {
                  routes.splice(index, 1);
               }
               exists = true;
            }
         }
         
         if (!exists)
            routes.push(
               {
                  from: connectFrom.id,
                  to: connectTo.id
               }
            );
            
         createRoutes();
      }
      connectFrom = null;
      connectTo = null;
   }
}
               }
            },
            {
               "button": {
                  "className": "delete",
                  "innerText": "Delete",
                  "onclick":
function (event) {
   if (!confirm("Delete " + label + "?"))
      return false;
      
   var form = document.getElementById(label);
   form.remove();
   delete procedures[label];
   
   if (!procedures.routes)
      procedures.routes = [];
      
   var routes = procedures.routes;
   
   for (var index = 0;
        index < routes.length;
        )
   {
      var route = routes[index];
      if (route.from == label ||
          route.to == label)
      {
         routes.splice(index, 1);
      }
      else
         ++index;
      
   }
   
   createRoutes();
   
   return true;
   
}
               }
            },
            {
               "button": {
                  "className": "go",
                  "innerText": "Go",
                  "onclick":
function (event) {
   var procedure = procedures[label];
   var form = document.getElementById(makeId(label));
      setFormClass(label);
   
   if (procedure.function) {
      if (!procedure.f) {
         compileFunction(label);
      }
      if (procedure.f) {
         procedure.f();
         setFormClass(label, "complete");
      }
   }
   else if (procedure.input) {
      var inputId = makeId(label, "input");
      var input = document.getElementById(inputId);
      procedure.value = input.value;
      setFormClass(label, "complete");
   }
}
               }
            }
            
         ]
         
      }
   };
   /*
   document.write("<pre>");
   document.write(JSON.stringify(json, null, "   "));
   document.write("</pre>");
   */
   HTML(json, document.body);
   
      // Create the function div json
   function createFunctionDiv()
   {

      var functionDiv =
      {
         "div": {
            "id": makeId(label, "functionDiv"),
            "style": {
               "display": procedure.function ? "block" : "none"
            },
            "children": [
               {
                  "textarea": {
                     "id": makeId(label, "function"),
                     "innerHTML": procedure.function,
                     "oninput":
function(event) {
   setFormClass(label, "ready");
},
                     "onchange":
function(event) {
   procedure.function = this.value;
   delete procedure.f;
   return true;
}
                  }
               }
            ]
         }
      };
      
      return functionDiv;
     
   }
   
   // Create the goto div json
   function createGotoDiv()
   {
      var gotoDiv =
      {
         "div": {
            "id": makeId(label, "gotoDiv"),
            "className": "gotoSVG",
            "style": {
               "display": procedure.goto ? "block" : "none",
            },
            "children": [
               {
                  "svg": {
                     "id": makeId(label, "svg"),
                     "attributes": {
                        "width": "300",
                        "height": "150"
                     },
                     "children": [
                        {
                           "g": {
                              "attributes": {
                                 "transform": "rotate(45, 50, 50) translate(40, 0)"
                              },
                              "children" : [
                                 {
                                    "rect": {
                                       "attributes" : {
                                          "width": "100",
                                          "height": "100",
                                          "x": "0",
                                          "y": "0",
                                          "rx": "0",
                                          "ry": "0",
                                          "fill": "pink",
                                          "stroke": "black"
                                       }
                                    }
                                 }
                              ]
                           }
                        },
                        {
                           "line": {
                              "attributes": {
                                 "x1": "147",
                                 "y1": "78",
                                 "x2": "200",
                                 "y2": "78",
                                 "stroke": "black"
                              }
                           }
                        }
                     ]
                  }
               },
               {
                  "select": {
                     "className": "gotoSelect",
                     "children": [
                        createOption("Select goto", undefined, true)
                     ],
                     "onfocus":
function(event) {
   var select = this;
   select.innerHTML = "";
   for (var _label in procedures) {
      if (_label != label &&
          _label != "routes")
         select.add(
            new Option(
               _label,
               makeId(_label),
               false,
               _label == procedures[label]["goto"]
            )
         );
   }
},
                     "onchange":
function(event) {
   var procedure = procedures[label];
   delete procedure.function;
   delete procedure.input;
   procedure.goto = this.value;
}
                  }
               }
            ]
         }
      };
      
      return gotoDiv;
   }
   
   
   // Create the input div json
   function createInputDiv() {
      var inputDiv = {
         "div": {
            "id": makeId(label, "inputDiv"),
            "style": {
               "display": procedure["input"] ? "block" : "none"
            },
            "children": [
               {
                  "select": {
                     "onchange":
function (event) {
   var inputId = makeId(label, "input");
   var input = document.getElementById(inputId);
   
   input.type = this.value;
   input.value = "";
   procedure.input = input.type;
   delete procedure.value;
   delete procedure.function;
   delete procedure.goto;
   
   setFormClass(label, "ready");
},
                     "children": [
                        createOption("Button", "button", procedure["input"] == "button"),
                        createOption("Check box", "checkbox", procedure["input"] == "checkbox"),
                        createOption("Color", "color", procedure["input"] == "color"),
                        createOption("Date", "date", procedure["input"] == "date"),
                        createOption("Date time", "datetime-local", procedure["input"] == "datetime-local"),
                        createOption("Email", "email", procedure["input"] == "email"),
                        createOption("File", "file", procedure["input"] == "file"),
                        createOption("Image", "image", procedure["input"] == "image"),
                        createOption("Month", "month", procedure["input"] == "month"),
                        createOption("Number", "number", procedure["input"] == "number"),
                        createOption("Password", "password", procedure["input"] == "password"),
                        createOption("Radio", "radio", procedure["input"] == "radio"),
                        createOption("Range", "range", procedure["input"] == "range"),
                        createOption("Reset", "reset", procedure["input"] == "reset"),
                        createOption("Search", "search", procedure["input"] == "search"),
                        createOption("Submit", "submit", procedure["input"] == "submit"),
                        createOption("Telephone", "tel", procedure["input"] == "tel"),
                        createOption("Text", "text", procedure["input"] == "text"),
                        createOption("Time", "time", procedure["input"] == "button"),
                        createOption("URL", "url", procedure["input"] == "time"),
                        createOption("Week", "week", procedure["input"] == "week"),
                     ]
                  }
               },
               {
                  "input": {
                     "id": makeId(label, "input"),
                     "type": procedure.input,
                     "value": procedure.value
                  }
               }
            ]
         }
      };
      
      return inputDiv;
   }
   
   
}

function makeId(label, id) {
    
   var _id = label + (id ? " " + id : "");

   //_id = _id.replaceAll(" ", "_");
  
   return _id;}

function setFormClass(label, className) {
   var form = document.getElementById(makeId(label));
   form.classList.remove("error");
   form.classList.remove("ready");
   form.classList.remove("complete");
   if (className)
      form.classList.add(className);
}


function createOption(label, value, selected=undefined) {
   return {
      "option": {
         "value": value,
         "innerText": label,
         "selected": selected ? "true" : undefined
      }
   }
}

function compileFunction(label)
{
   var procedure = procedures[label];
   
   delete procedure.f;
   delete procedure.input;
   delete procedure.goto;
   
   try {
      var func = new Function("return " + procedure.function);
      var f = func();
      if (typeof f == "function") {
         procedure.f = f;
         setFormClass(label, "ready");
         return true;
      }
      throw "Text must be a function";
   }
   catch (error)
   {
      Error(error, compileFunction);
      setFormClass(label, "error");
      return false;
   }
   
   
}
   

function onProcedureTypeChange(select, divIds) {
   // Hide all
   for (var i = 0; i < divIds.length; ++i) {
      var id = divIds[i];
      var div = document.getElementById(id);
      div.style.display = "none";
   }
   
   // Display selected
   var selected = select.value;
   var div = document.getElementById(selected);
   
   div.style.display = "block";
   
}

function onNewProcedure(event) {
   var label = "Procedure ";
   var count = 1;
   while (procedures[label + count])
      ++count;
      
   label += count;
   
   while (true) {
      label = prompt("New procedure", label);
      if (!label)
         return;
         
      if (procedures[label])
         alert(label + " already exists");
      else
         break;
         
   };
   
   var point = coordinates.getCoordinates(event);
   
   procedures[label] = {
      "function": "function() {\r\n   alert('hello');\r\n}",
      "topLeft": {
         "x": point.x - 125,
         "y": point.y
      }
   };
   
   createProcedure(label);
   
}
function createProcedures() {
   for (var label in procedures) {
      if (label != "routes")
         createProcedure(label);
   }
   createRoutes();
}

function createRoutes() {
   var svg = document.getElementById("svg");
   svg.innerHTML = "";
   
   if (!procedures.routes)
      procedures.routes = [];
      
   for (var index = 0;
        index < procedures.routes.length;
        ++index)
   {
      var route = procedures.routes[index];
      createRoute(route);
   }
   
   
   
}

function createRoute(route) {
    
   var svg = document.getElementById("svg");
   
   var from = document.getElementById(makeId(route.from));
   var to = document.getElementById(makeId(route.to));
   var fromRect = from.getBoundingClientRect();
   var toRect = to.getBoundingClientRect();
   
   var line = document.createElementNS("http://www.w3.org/2000/svg", "line");
   var _from = procedures[route.from].topLeft;
   var _to = procedures[route.to].topLeft;

   line.setAttribute("x1", _from.x + fromRect.width / 2);
   line.setAttribute("y1", _from.y + fromRect.height);
   line.setAttribute("x2", _to.x + toRect.width / 2);
   line.setAttribute("y2", _to.y);
   line.setAttribute("stroke", "blue");
   
   svg.appendChild(line);
   
}

function changeLabel(oldLabel, newLabel) {
   var oldForm = document.getElementById(oldLabel);
   oldForm.remove();
   var oldProcedure = procedures[oldLabel];
   delete procedures[oldLabel];
   procedures[newLabel] = oldProcedure;
   
   
   // re route
   if (!procedures.routes)
      procedures.routes = [];
      
   var routes = procedures.routes;
   
   for (var index = 0;
        index < routes.length;
        ++index)
   {
      var route = routes[index];
      if (route.from == oldLabel)
         route.from = newLabel;
      if (route.to == oldLabel)
         route.to = newLabel;
   }
   
   createProcedure(newLabel);
   createRoutes();
}

document.getElementById("svg").onclick =
   function (event) {
      connectFrom = null;
      connectTo = null;
      onNewProcedure(event);
   }
window.onresize =
   function(event) {
      var maxWidth = 0;
      var maxHeight = 0;
      for (var label in procedures) {
         if (label != "routes") {
            var form = document.getElementById(makeId(label));
            var rect = form.getBoundingClientRect();
            var topLeft = procedures[label].topLeft;
            if (topLeft.x + rect.width > maxWidth)
               maxWidth = topLeft.x + rect.width;
               
            if (topLeft.y + rect.height > maxHeight)
               maxHeight = topLeft.y + rect.height;
         }
      }

      document.body.style.width = maxWidth * 2 + "px";
      document.body.style.height = maxHeight * 2 + "px";

      var svg = document.getElementById("svg");
      
      svg.style.width = document.body.style.width;
      svg.style.height = document.body.style.height;
      
      createRoutes();
   }
   
createProcedures();
window.onresize();
      </script>
      
      
      <script>
var header = document.getElementById("h1");
var title = document.getElementById("title");

var origin =
   punycode.toUnicode(
      window.location.hostname
   );

header.innerText = "Procedure " + origin;
title.innerText = origin;

      </script>
   </body>

</html>